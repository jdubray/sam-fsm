(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):(a=a||self,a.tpFSM=b())})(this,function(){'use strict';function a(a,b){const c=Object.keys(a);return c.includes(b)}function b(b,c){const d=c;return function(c,e){if(a(b,e)&&c){const a=async function(){const a=await c.apply(this,arguments);return a.__actionName=e,a.__stateMachineId=d,a};return a.__actionName=e,a.__stateMachineId=d,a}throw new Error(`addAction invalid action: ${e}`)}}function c({pc0:a,actions:b,transitions:c,states:e,composite:f,pc:i="pc",id:g,componentName:h,deterministic:j=!1,lax:k=!0,enforceAllowedTransitions:l=!1,blockUnexpectedActions:n=!1}){const o=d(e,c),p=Object.keys(o.states),q=[a=>()=>{const b=m(a,h,`${i}_1`),c=m(a,h,i),d=a.__actionName,e=a.__stateMachineIdForLastAction;if(!k&&!p.includes(c))a.__error=`unexpected state: ${c}`;else try{d&&b&&!o.states[b].transitions.includes(d)&&e===g&&(a.__error=`unexpected action ${d} for state: ${c}`)}catch(b){a.__error=`unexpected error: ${b.message} for action ${d} and state: ${c}`}}];return n&&q.push(a=>()=>{const b=m(a,h,i),{transitions:c=[],guards:d=[]}=o.states[b];a.__blockUnexpectedActions=!0,a.__allowedActions=(a.__allowedActions||[]).concat(c.filter(b=>d.reduce((d,e)=>(e.action||c[0])===b?d&&e.condition(a):d&&!0,!0))),0===a.allowedActions().length&&(a.__allowedActions=["__EMPTY"])}),f&&q.push(a=>()=>{const c=m(a,f.onState.component,f.onState.pc);c!==f.onState?.label&&(a.__disallowedActions=(a.__disallowedActions||[]).concat(Object.keys(b)))}),q}function d(a,b){if(!a){let a;switch(typeof b){case"object":a=k(l(b));break;default:a=k(b);}return a}return{states:a}}function e({pc0:a,actions:b,states:c,composite:e,transitions:f,pc:g,id:h,componentName:i,deterministic:j,lax:k,enforceAllowedTransitions:l,stateDiagram:q}){const s=d(c,f),t=Object.keys(s.states);b=b||s.actions;const u=j?[a=>c=>{if(!c.__stateMachineId||c.__stateMachineId===h){const d=m(a,i,g);if(!l||l&&s.states[d].transitions.includes(c.__actionName))n(a,i,`${g}_1`,d),n(a,i,g,o(b,c.__actionName)),r(q,m(a,i,g),d,c.__actionName);else if(e){const g=Object.keys(p(b,f)).map(a=>a===c.__actionName).reduce((a,b)=>b||a,!1);g&&m(a,e.onState?.component,e.onState?.pc)===e.onState?.label&&(a.__error=`unexpected action ${c.__actionName} for state: ${d}`)}else a.__error=`unexpected action ${c.__actionName} for state: ${d}`}}]:t.map(a=>s.states[a].acceptor);return u.unshift(a=>b=>{a.__actionName=b.__actionName,a.__stateMachineIdForLastAction=b.__stateMachineId},a=>()=>{a.__allowedActions=[],a.__disallowedActions=[]}),u}function f({states:a,composite:b,transitions:c,pc:e,componentName:f}){const g=d(a,c),h=Object.keys(g.states),i=h.map(a=>(g.states[a].naps||[]).map(b=>({state:a,condition:b.condition,nextAction:b.nextAction}))).flat().map(a=>b=>()=>{if(b[e]===a.state&&a.condition(b))return a.nextAction(b),!1});return b?i.concat(b.transitions.map(a=>b=>()=>{if(b[e]===a.onState)return a.action(a.proposal.reduce((a,c)=>Object.assign(a,{[c]:b[c]}),{})),!1})):i}function g({pc0:a,actions:b,states:c,transitions:e,deterministic:f}){const g=d(c,e);b=b||g.actions;let h;const i=Object.keys(c).map(a=>(h=h||c[a]?.transitions&&c[a].transitions[0]?void 0:a,(c[a].transitions||[]).map(d=>{const e=(c[a].guards||[]).reduce((b,a)=>a.action===d?a.condition.toString().split("return")[1].split(";")[0]:b,void 0);return s(a,b[d][0],d,e)}).join("\n"))).join("\n"),j=`
digraph fsm_diagram {
rankdir=LR;
size="8,5"
${a} [shape = circle margin=0 fixedsize=true width=0.33 fontcolor=black style=filled color=black label="\\n\\n\\n${a}"]
${h?`${h} [shape = doublecircle margin=0 style=filled fontcolor=white color=black]`:"\n"}
node [shape = Mrecord];
${i}
}
    `;return j}function h(a,b,c){return b.actions={},b.states={[a]:{transitions:[]}},b.step=0,()=>g({pc0:a,actions:b.actions,states:b.states,deterministic:c})}function i({componentName:a,pc0:d,actions:i,transitions:j,states:k,composite:l,pc:m="pc",deterministic:o=!1,lax:p=!0,enforceAllowedTransitions:q=!1,blockUnexpectedActions:r=!1,stateDiagram:s={},id:t=Date.now()+Math.floor(1e8*Math.random())}){return{id:t,initialState:b=>(n(b,a,m,d),b.__actionName=void 0,b),addAction:b(i,t),stateMachine:c({id:t,componentName:a,pc0:d,actions:i,states:k,composite:l,transitions:j,pc:m,deterministic:o,lax:p,enforceAllowedTransitions:q,blockUnexpectedActions:r,stateDiagram:s}),acceptors:e({id:t,componentName:a,pc0:d,actions:i,states:k,composite:l,transitions:j,pc:m,deterministic:o,lax:p,enforceAllowedTransitions:q,stateDiagram:s}),naps:f({id:t,states:k,componentName:a,composite:l,pc:m}),event:a=>{const b=()=>({__actionName:a,__stateMachineId:t});return b.__actionName=a,b.__stateMachineId=t,b},stateDiagram:g({pc0:d,actions:i,transitions:j,states:k,deterministic:o}),runtimeStateDiagram:h(d,s,o)}}const j=(b,c)=>(b.push(c),b),k=a=>({pc0:a[0].from,states:a.reduce((a,b)=>Object.assign(a,{[b.from]:{transitions:a[b.from]&&a[b.from].transitions&&a[b.from].transitions[0]?j(a[b.from].transitions,b.on):[b.on]},[b.to]:a[b.to]&&a[b.to].transitions[0]?a[b.to]:{transitions:b.to===b.from?[b.on]:[]}}),{}),actions:a.reduce((b,a)=>Object.assign(b,{[a.on]:[a.to]}),{}),deterministic:!0,enforceAllowedTransitions:!0}),l=a=>Object.keys(a).reduce((b,c)=>{const d=a[c],e=Object.keys(d);return b.concat(e.map(b=>({from:c,to:d[b],on:b})))},[]),m=(a,b,c="pc")=>b?"function"==typeof a.localState?a.localState(b)[c]:a.__components?a.__components[b][c]:void 0:a[c],n=(a,b,c,d)=>(b?"function"==typeof a.localState?a.localState(b)[c]=d:a.__components={[b]:{[c]:d}}:a[c]=d,d),o=(a,b)=>a[b][0],p=(a,b)=>a?a:k(b).actions,q=(a=0,b="other")=>`${a}. ${b}`,r=(a,b,c,d="other")=>{a.step=1+(a.step||0);const e=q(a.step,d);a.states[b]||(a.states[b]={transitions:[]}),a.actions[e]?-1===a.actions[e].indexOf(b)&&a.actions[e].push(b):a.actions[e]=[b],c&&a.states[c]&&-1===a.states[c].transitions.indexOf(e)&&a.states[c].transitions.push(e)},s=(a,b,c="",d)=>`${a} -> ${b} [label = "${c}${d?`\\n${d}`:""}"];`;i.flattenTransitions=l,i.actionsAndStatesFor=k;return{fsm:i}});