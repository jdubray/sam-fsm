(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):(a=a||self,a.tpFSM=b())})(this,function(){'use strict';function a(a,b){const c=Object.keys(a);return c.includes(b)}function b(b,c){const d=c;return function(c,e){if(a(b,e)&&c){const a=async function(){const a=await c.apply(this,arguments);return a.__actionName=e,a.__stateMachineId=d,a};return a.__actionName=e,a.__stateMachineId=d,a}throw new Error(`addAction invalid action: ${e}`)}}function c({pc0:a,actions:b,transitions:c,states:e,composite:f,pc:i="pc",id:g,componentName:h,deterministic:j=!1,lax:k=!0,enforceAllowedTransitions:m=!1,blockUnexpectedActions:n=!1}){const o=d(e,c),p=Object.keys(o.states),q=[a=>()=>{const b=l(a,h,`${i}_1`),c=l(a,h,i),d=a.__actionName,e=a.__stateMachineIdForLastAction;if(!k&&!p.includes(c))a.__error=`unexpected state: ${c}`;else try{d&&b&&!o.states[b].transitions.includes(d)&&e===g&&(a.__error=`unexpected action ${d} for state: ${c}`)}catch(b){a.__error=`unexpected error: ${b.message} for action ${d} and state: ${c}`}}];return n&&q.push(a=>()=>{const b=l(a,h,i),{transitions:c=[],guards:d=[]}=o.states[b];a.__blockUnexpectedActions=!0,a.__allowedActions=(a.__allowedActions||[]).concat(c.filter(b=>d.reduce((d,e)=>(e.action||c[0])===b?d&&e.condition(a):d&&!0,!0))),0===a.allowedActions().length&&(a.__allowedActions=["__EMPTY"])}),f&&q.push(a=>()=>{const c=l(a,f.onState.component,f.onState.pc);c!==f.onState?.label&&(a.__disallowedActions=(a.__disallowedActions||[]).concat(Object.keys(b)))}),q}function d(a,b){if(!a){let a;switch(typeof b){case"object":a=j(k(b));break;default:a=j(b);}return a}return{states:a}}function e({pc0:a,actions:b,states:c,composite:e,transitions:f,pc:g,id:h,componentName:i,deterministic:j,lax:k,enforceAllowedTransitions:p}){const q=d(c,f),r=Object.keys(q.states);b=b||q.actions;const s=j?[a=>c=>{if(c.__stateMachineId===h){const d=l(a,i,g);if(!p||p&&q.states[d].transitions.includes(c.__actionName))m(a,i,`${g}_1`,d),m(a,i,g,n(b,c.__actionName));else if(e){const g=Object.keys(o(b,f)).map(a=>a===c.__actionName).reduce((a,b)=>b||a,!1);g&&l(a,e.onState?.component,e.onState?.pc)===e.onState?.label&&(a.__error=`unexpected action ${c.__actionName} for state: ${d}`)}else a.__error=`unexpected action ${c.__actionName} for state: ${d}`}}]:r.map(a=>q.states[a].acceptor);return s.unshift(a=>b=>{a.__actionName=b.__actionName,a.__stateMachineIdForLastAction=b.__stateMachineId},a=>()=>{a.__allowedActions=[],a.__disallowedActions=[]}),s}function f({states:a,composite:b,transitions:c,pc:e,componentName:f}){const g=d(a,c),h=Object.keys(g.states),i=h.map(a=>(g.states[a].naps||[]).map(b=>({state:a,condition:b.condition,nextAction:b.nextAction}))).flat().map(a=>b=>()=>{if(b[e]===a.state&&a.condition(b))return a.nextAction(b),!1});return b?i.concat(b.transitions.map(a=>b=>()=>{if(b[e]===a.onState)return a.action(a.proposal.reduce((a,c)=>Object.assign(a,{[c]:b[c]}),{})),!1})):i}function g({pc0:a,actions:b,states:c,transitions:e,deterministic:f}){const g=d(c,e);b=b||g.actions;let h;const i=Object.keys(c).map(a=>(h=h||c[a]?.transitions&&c[a].transitions[0]?void 0:a,(c[a].transitions||[]).map(d=>{const e=(c[a].guards||[]).reduce((b,a)=>a.action===d?a.condition.toString().split("return")[1].split(";")[0]:b,void 0);return p(a,b[d][0],d,e)}).join("\n"))).join("\n"),j=`
digraph fsm_diagram {
rankdir=LR;
size="8,5"
${a} [shape = circle margin=0 fixedsize=true width=0.33 fontcolor=black style=filled color=black label="\\n\\n\\n${a}"]
${h?`${h} [shape = doublecircle margin=0 style=filled fontcolor=white color=black]`:"\n"}
node [shape = Mrecord];
${i}
}
    `;return j}function h({id:l=Date.now(),componentName:a,pc0:d,actions:h,transitions:i,states:j,composite:k,pc:n="pc",deterministic:o=!1,lax:p=!0,enforceAllowedTransitions:q=!1,blockUnexpectedActions:r=!1}){return{id:l,initialState:b=>(m(b,a,n,d),b.__actionName=void 0,b),addAction:b(h,l),stateMachine:c({id:l,componentName:a,pc0:d,actions:h,states:j,composite:k,transitions:i,pc:n,deterministic:o,lax:p,enforceAllowedTransitions:q,blockUnexpectedActions:r}),acceptors:e({id:l,componentName:a,pc0:d,actions:h,states:j,composite:k,transitions:i,pc:n,deterministic:o,lax:p,enforceAllowedTransitions:q}),naps:f({id:l,states:j,componentName:a,composite:k,pc:n}),event:a=>{const b=()=>({__actionName:a,__stateMachineId:l});return b.__actionName=a,b.__stateMachineId=l,b},stateDiagram:g({pc0:d,actions:h,transitions:i,states:j,deterministic:o})}}const i=(b,c)=>(b.push(c),b),j=a=>({pc0:a[0].from,states:a.reduce((a,b)=>Object.assign(a,{[b.from]:{transitions:a[b.from]&&a[b.from].transitions&&a[b.from].transitions[0]?i(a[b.from].transitions,b.on):[b.on]},[b.to]:a[b.to]&&a[b.to].transitions[0]?a[b.to]:{transitions:b.to===b.from?[b.on]:[]}}),{}),actions:a.reduce((b,a)=>Object.assign(b,{[a.on]:[a.to]}),{}),deterministic:!0,enforceAllowedTransitions:!0}),k=a=>Object.keys(a).reduce((b,c)=>{const d=a[c],e=Object.keys(d);return b.concat(e.map(b=>({from:c,to:d[b],on:b})))},[]),l=(a,b,c="pc")=>b?"function"==typeof a.localState?a.localState(b)[c]:a.__components?a.__components[b][c]:void 0:a[c],m=(a,b,c,d)=>(b?"function"==typeof a.localState?a.localState(b)[c]=d:a.__components={[b]:{[c]:d}}:a[c]=d,d),n=(a,b)=>a[b][0],o=(a,b)=>a?a:j(b).actions,p=(a,b,c="",d)=>`${a} -> ${b} [label = "${c}${d?`\\n${d}`:""}"];`;h.flattenTransitions=k,h.actionsAndStatesFor=j;return{fsm:h}});