(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):(a=a||self,a.tpFSM=b())})(this,function(){'use strict';function a(a,b){const c=Object.keys(a);return c.includes(b)}function b(b){return function(c,d){if(a(b,d)&&c){const a=async function(){const a=await c.apply(this,arguments);return a.__actionName=d,a};return a.__actionName=d,a}throw new Error(`addAction invalid action: ${d}`)}}function c({pc0:a,actions:b,transitions:c,states:e,pc:g="pc",componentName:f,deterministic:h=!1,lax:i=!0,enforceAllowedTransitions:j=!1,blockUnexpectedActions:k=!1}){const m=d(e,c),n=Object.keys(m.states),o=[a=>()=>{const b=l(a,f,`${g}_1`),c=l(a,f,g),d=a.__actionName;if(!i&&!n.includes(c))a.__error=`unexpected state: ${c}`;else try{d&&b&&!m.states[b].transitions.includes(d)&&(a.__error=`unexpected action ${d} for state: ${c}`)}catch(b){a.__error=`unexpected error: ${b.message} for action ${d} and state: ${c}`}}];return k&&o.push(a=>()=>{const b=l(a,f,g),{transitions:c=[],guards:d=[]}=m.states[b];a.__blockUnexpectedActions=!0,a.__allowedActions=(a.__allowedActions||[]).concat(c.filter(b=>d.reduce((d,e)=>(e.action||c[0])===b?d&&e.condition(a):d&&!0,!0))),0===a.__allowedActions.length&&(a.__allowedActions=["__EMPTY"])}),o}function d(a,b){if(!a){let a;switch(typeof b){case"object":a=j(k(b));break;default:a=j(b);}return a}return{states:a}}function e({pc0:a,actions:b,states:c,transitions:e,pc:f,componentName:g,deterministic:h,lax:i,enforceAllowedTransitions:j}){const k=d(c,e),o=Object.keys(k.states);b=b||k.actions;const p=h?[a=>c=>{const d=l(a,g,f);!j||j&&k.states[d].transitions.includes(c.__actionName)?(m(a,g,`${f}_1`,d),m(a,g,f,n(b,c.__actionName))):a.__error=`unexpected action ${c.__actionName} for state: ${d}`}]:o.map(a=>k.states[a].acceptor);return p.push(a=>b=>{a.__actionName=b.__actionName}),p.push(a=>()=>{a.__allowedActions=[]}),p}function f({states:a,transitions:b,pc:c,componentName:e}){const f=d(a,b),g=Object.keys(f.states);return g.map(a=>(f.states[a].naps||[]).map(b=>({state:a,condition:b.condition,nextAction:b.nextAction}))).flat().map(a=>b=>()=>{if(b[c]===a.state&&a.condition(b))return a.nextAction(b),!1})}function g({pc0:a,actions:b,states:c,transitions:e,deterministic:f}){const g=d(c,e);b=b||g.actions;let h;const i=Object.keys(c).map(a=>(h=h||c[a]?.transitions&&c[a].transitions[0]?void 0:a,(c[a].transitions||[]).map(c=>o(a,b[c][0],c)).join("\n"))).join("\n"),j=`
digraph fsm_diagram {
rankdir=LR;
size="8,5"
${a} [shape = circle margin=0 fixedsize=true width=0.33 fontcolor=black style=filled color=black label="\\n\\n\\n${a}"]
${a} [box]
${h?`${h} [shape = doublecircle margin=0 style=filled fontcolor=white color=black]`:"\n"}
node [shape = Mrecord];
${i}
}
    `;return j}function h({componentName:a,pc0:d,actions:h,transitions:i,states:j,pc:k="pc",deterministic:l=!1,lax:n=!0,enforceAllowedTransitions:o=!1,blockUnexpectedActions:p=!1}){return{initialState:b=>(m(b,a,k,d),b.__actionName=void 0,b),addAction:b(h),stateMachine:c({componentName:a,pc0:d,actions:h,states:j,transitions:i,pc:k,deterministic:l,lax:n,enforceAllowedTransitions:o,blockUnexpectedActions:p}),acceptors:e({componentName:a,pc0:d,actions:h,states:j,transitions:i,pc:k,deterministic:l,lax:n,enforceAllowedTransitions:o}),naps:f({states:j,componentName:a,pc:k}),event:a=>{const b=()=>({__actionName:a});return b.__actionName=a,b},stateDiagram:g({pc0:d,actions:h,transitions:i,states:j,deterministic:l})}}const i=(b,c)=>(b.push(c),b),j=a=>({pc0:a[0].from,states:a.reduce((a,b)=>Object.assign(a,{[b.from]:{transitions:a[b.from]&&a[b.from].transitions&&a[b.from].transitions[0]?i(a[b.from].transitions,b.on):[b.on]},[b.to]:a[b.to]&&a[b.to].transitions[0]?a[b.to]:{transitions:b.to===b.from?[b.on]:[]}}),{}),actions:a.reduce((b,a)=>Object.assign(b,{[a.on]:[a.to]}),{}),deterministic:!0,enforceAllowedTransitions:!0}),k=a=>Object.keys(a).reduce((b,c)=>{const d=a[c],e=Object.keys(d);return b.concat(e.map(b=>({from:c,to:d[b],on:b})))},[]),l=(a,b,c)=>b?"function"==typeof a.localState?a.localState(b)[c]:a.__components?a.__components[b][c]:void 0:a[c],m=(a,b,c,d)=>(b?"function"==typeof a.localState?a.localState(b)[c]=d:a.__components={[b]:{[c]:d}}:a[c]=d,d),n=(a,b)=>a[b][0],o=(a,b,c="")=>`${a} -> ${b} [label = "${c}"];`;h.flattenTransitions=k,h.actionsAndStatesFor=j;return{fsm:h}});