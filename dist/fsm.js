(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):(a=a||self,a.tpFSM=b())})(this,function(){'use strict';function a(a,b){const c=Object.keys(a);return c.includes(b)}function b(b){return function(c,d){if(a(b,d)&&c){const a=async function(){const a=await c.apply(this,arguments);return a.__actionName=d,a};return a.__actionName=d,a}throw new Error(`addAction invalid action: ${d}`)}}function c({pc0:a,actions:b,transitions:c,states:e,pc:g="pc",componentName:f,deterministic:h=!1,lax:i=!0,enforceAllowedTransitions:j=!1,blockUnexpectedActions:l=!1}){const m=d(e,c),n=Object.keys(m.states),o=[a=>()=>{const b=k(a,f,`${g}_1`),c=k(a,f,g),d=a.__actionName;if(!i&&!n.includes(c))a.__error=`unexpected state: ${c}`;else try{d&&b&&!m.states[b].transitions.includes(d)&&(a.__error=`unexpected action ${d} for state: ${c}`)}catch(b){a.__error=`unexpected error: ${b.message} for action ${d} and state: ${c}`}}];return l&&o.push(a=>()=>{const b=k(a,f,g),{transitions:c=[],guards:d=[]}=m.states[b];a.__blockUnexpectedActions=!0,a.__allowedActions=(a.__allowedActions||[]).concat(c.filter(b=>d.reduce((d,e)=>(e.action||c[0])===b?d&&e.condition(a):d&&!0,!0))),0===a.__allowedActions.length&&(a.__allowedActions=["__EMPTY"])}),o}function d(a,b){if(!a){let a;switch(typeof b){case"object":a=i(j(b));break;default:a=i(b);}return a}return{states:a}}function e({pc0:a,actions:b,states:c,transitions:e,pc:f,componentName:g,deterministic:h,lax:i,enforceAllowedTransitions:j}){const n=d(c,e),o=Object.keys(n.states);b=b||n.actions;const p=h?[a=>c=>{const d=k(a,g,f);!j||j&&n.states[d].transitions.includes(c.__actionName)?(l(a,g,`${f}_1`,d),l(a,g,f,m(b,c.__actionName))):a.__error=`unexpected action ${c.__actionName} for state: ${d}`}]:o.map(a=>n.states[a].acceptor);return p.push(a=>b=>{a.__actionName=b.__actionName}),p.push(a=>()=>{a.__allowedActions=[]}),p}function f({states:a,transitions:b,pc:c,componentName:e}){const f=d(a,b),g=Object.keys(f.states);return g.map(a=>(f.states[a].naps||[]).map(b=>({state:a,condition:b.condition,nextAction:b.nextAction}))).flat().map(a=>b=>()=>{if(b[c]===a.state&&a.condition(b))return a.nextAction(b),!1})}function g({componentName:a,pc0:d,actions:g,transitions:h,states:i,pc:j="pc",deterministic:k=!1,lax:m=!0,enforceAllowedTransitions:n=!1,blockUnexpectedActions:o=!1}){return{initialState:b=>(l(b,a,j,d),b.__actionName=void 0,b),addAction:b(g),stateMachine:c({componentName:a,pc0:d,actions:g,states:i,transitions:h,pc:j,deterministic:k,lax:m,enforceAllowedTransitions:n,blockUnexpectedActions:o}),acceptors:e({componentName:a,pc0:d,actions:g,states:i,transitions:h,pc:j,deterministic:k,lax:m,enforceAllowedTransitions:n}),naps:f({states:i,componentName:a,pc:j}),event:a=>{const b=()=>({__actionName:a});return b.__actionName=a,b}}}const h=(b,c)=>(b.push(c),b),i=a=>({pc0:a[0].from,states:a.reduce((a,b)=>Object.assign(a,{[b.from]:{transitions:a[b.from]&&a[b.from].transitions&&a[b.from].transitions[0]?h(a[b.from].transitions,b.on):[b.on]},[b.to]:a[b.to]&&a[b.to].transitions[0]?a[b.to]:{transitions:b.to===b.from?[b.on]:[]}}),{}),actions:a.reduce((b,a)=>Object.assign(b,{[a.on]:[a.to]}),{}),deterministic:!0,enforceAllowedTransitions:!0}),j=a=>Object.keys(a).reduce((b,c)=>{const d=a[c],e=Object.keys(d);return b.concat(e.map(b=>({from:c,to:d[b],on:b})))},[]),k=(a,b,c)=>b?"function"==typeof a.localState?a.localState(b)[c]:a.__components?a.__components[b][c]:void 0:a[c],l=(a,b,c,d)=>(b?"function"==typeof a.localState?a.localState(b)[c]=d:a.__components={[b]:{[c]:d}}:a[c]=d,d),m=(a,b)=>a[b][0];g.flattenTransitions=j,g.actionsAndStatesFor=i;return{fsm:g}});